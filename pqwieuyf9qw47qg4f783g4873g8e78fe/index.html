<html>
  <head>
    <title>Axerve - Lightbox sandbox</title>    
    <link href="../style.css" rel="stylesheet" type="text/css">
    <link rel="icon" href="../assets/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  </head>
  <body>
    <div class="c-background">
      <div class="c-background__logo"></div>
      <div class="c-background__links">
        <a href="http://doc.gestpay.it">Documentazione</a>
        <a href="http://api.gestpay.it">API</a>
      </div>
      <div class="c-container">
        <div class="c-container__content">
          <div class="c-container__inputs">
            <div class="c-container__input">
              <label>Amount</label>
              <input type="number" value="5.00" name="amount" id="amount" min="0">
            </div>
            <div class="c-container__input currency">
              <label>Currency</label>
              <select name="currency" id="currency">
                <option checked value="EUR">EUR</option>
              </select>
            </div>
          </div>
          <a id="popupButton" href="#" target="_blank">Test Lightbox popup</a>
          <form id="boxRisultato" name="boxRisultato">
            <b>Codice</b>: <input text disabled id="codice" name="codice" value="initial"><br>
            <b>Messaggio</b>: <input text disabled id="messaggio" name="messaggio" value="initial">
          </div>
        </div>
      </div>
    </div>
    <script src="https://sandbox.gestpay.net/pagam/javascript/axerve.js"></script>
  </body>
</html>

<script>
  var amountInput = document.getElementById("amount");
  var currencyInput = document.getElementById("currency");
  var popupButton = document.getElementById("popupButton");

  popupButton.onclick  = function() {
    callSandbox();
  };

  callSandbox = function() {
    boxRisultato.codice.value = "";
    boxRisultato.messaggio.value = "";

    var amount = amountInput.value;
    var currency = currencyInput.value;
    var transaction = "my-custom-id";

    popupButton.setAttribute('href', "index.html?amount=" + amount + '&currency=' + currency + '&transaction=' + transaction);
    return true;
  };

  setOpener = function (key, value) {
    if (window.opener && !window.opener.closed) {
      window.opener.document.boxRisultato[key].value = value;
    }
  };

  console.log(window.opener)

  callback = function(response) {
    console.log(response);
    if(response.error.code !== "0" && response.error.code !== null && response.status !== "OK" && response.status !== "XX") {
      setOpener("codice", response.error.code);
      setOpener("messaggio", response.error.description);
    } else {
      setOpener("codice", "OK");
      setOpener("messaggio", "paymentId: " + response.paymentId + " responseUrl: " + response.responseURL);
    }
    window.opener.focus();
    window.close();
  };

  manageLightbox = function(data) {
    var paymentIdentity = {
      paymentId: data.payload.paymentID,
      paymentToken: data.payload.paymentToken
    };

    axerve.lightBox.shop = "LightboxTest";
    axerve.lightBox.open(paymentIdentity.paymentId, paymentIdentity.paymentToken, callback, window);
  };

  openSandbox = function(amount, currency, transaction) {
  
    fetch('https://sandbox.gestpay.net/api/v1/payment/create/',
      {
        method: 'POST',
        headers: {
          'Authorization': 'apikey TGlnaHRib3hUZXN0IyNlc2VyY2VudGUgcGVyIHRlc3Qgc3UgbGlnaHRib3gjIzE4LzEwLzIwMTkgMTE6MDc6NDY=',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({  
          "shopLogin": "LightboxTest",
          "amount": amount,
          "currency": currency,
          "shopTransactionID": transaction
        })
      }
    ).then(function(result) {
      return result.json();
    }).then(function(data) {
      if(data.error.code !== "0") {
        alert(data.error.description);
      } else {
        manageLightbox(data);
      }
    });

  };

  var queryString = window.location.search;
  var urlParams = new URLSearchParams(queryString);
  if (urlParams.has('amount') && urlParams.has('currency')) {
    var amount = urlParams.get('amount');
    var currency = urlParams.get('currency');
    var transaction = urlParams.get('transaction');
    openSandbox(amount, currency, transaction);
  }

</script>
